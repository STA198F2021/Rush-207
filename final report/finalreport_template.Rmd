---
title: "Final Report"
subtitle: "due November 16, 2021 by 11:59 PM "
author: "Shelby Brown, Katie Lam, Kaeden Hill"
date: "10/31/21"
output: pdf_document
---

```{r load-packages, echo=FALSE}
library(tidyverse) 
library(janitor)
library(tidymodels)
library(gridExtra)

knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)
``` 

```{r load-data, echo=FALSE}
heart <- readr::read_csv("heart.csv")

```



# Abstract

# Introduction

For this data visualization, chest pain types and their relation to other physiological factors were analyzed to search for an association between factors, such as blood pressure, cholesterol, and exercise, and the type of chest pain a patient experiences. The dataset being analyzed is the Heart Failure Prediction Dataset, retrieved from Kaggle, and compiled from five sets with common variables. These sources are the Hungarian Institute of Cardiology. Budapest, University Hospital, Zurich, Switzerland, University Hospital, Basel, Switzerland, the V.A. Medical Center, Long Beach, and the Cleveland Clinic Foundation. The variables of interest include gender, resting blood pressure (mm Hg), serum cholesterol (mm/d), whether or not the angina was exercise induced, and whether or not the patient was diagnosed with heart disease (**diagnosis before or after the angina??). To allow for the use of statistical tests, each variable was transformed into a categorical variable. 


```{r cholesterol}
heart_grouped <- heart %>%
  mutate(chol_level = cut(Cholesterol,
                          breaks = c(-Inf, 120, 200, 239, Inf),
                          labels = c("Low", "Normal", "Intermediate", "High"),
                          right=FALSE))

heart_grouped_chol <- heart_grouped %>%
  filter(Cholesterol > 0)
```

```{r bloodpressure}
heart_grouped <- heart_grouped %>%
  mutate(press_level = cut(RestingBP,
                          breaks = c(-Inf, 120, 130, 140, Inf),
                          labels = c("Normal", "Elevated", "Hypertension 1", "Hypertension 2"),
                          right=FALSE))
```


```{r factor}
heart_grouped <- heart_grouped %>%
  mutate(Sex, sex_factor=ifelse(Sex=="M", 0,1)) %>%
  mutate(ExerciseAngina, exer_factor=ifelse(ExerciseAngina=="N", 0,1))
```

```{r count-sex}
sex_grouped <- heart_grouped %>%
  group_by(ChestPainType, sex_factor) %>%
  summarize(count = n())
```

```{r count-ex}
exer_grouped <- heart_grouped %>%
  group_by(ChestPainType, exer_factor) %>%
  summarize(count = n())
```

```{r count-RBP}
RBP_grouped <- heart_grouped %>%
  group_by(ChestPainType, press_level) %>%
  summarize(count = n())
```

```{r count-cholesterol}
chol_grouped <- heart_grouped_chol %>%
  group_by(ChestPainType, chol_level)%>%
  summarize(count = n())
```

```{r count-disease}
disease_grouped <- heart_grouped %>%
  group_by(ChestPainType, HeartDisease) %>%
  summarize(count = n())

```


```{r visuals, fig.show = "hold", out.width = "50%"}
sex_grouped %>%
  mutate(sex_factor, sex_name=ifelse(sex_factor==0, "Male","Female")) %>%
  ggplot()+
  geom_col(aes(x = ChestPainType, y = count, fill = as.factor(sex_name)), position = "fill") +
  labs(title = "Frequency of Chest Pain Type by Sex",
       x = "Chest Pain Type",
       y = "Proportion",
       fill = "Sex")

exer_grouped %>%
  mutate(exer_factor, exer_cat=ifelse(exer_factor==0, "No","Yes")) %>%
  ggplot()+
  geom_col(aes(x = ChestPainType, y = count, fill = as.factor(exer_cat)), position = "fill") +
  labs(title = "Frequency of Chest Pain Type by Exercise",
       x = "Chest Pain Type",
       y = "Proportion",
       fill = "Exercise Induced Angina Status")

RBP_grouped %>%
  ggplot()+
  geom_col(aes(x = ChestPainType, y = count, fill = as.factor(press_level)), position = "fill") +
  labs(title = "Frequency of Chest Pain Type by Blood Pressure Level",
       x = "Chest Pain Type",
       y = "Proportion",
       fill = "Blood Pressure Level")

chol_grouped %>%
  ggplot()+
  geom_col(aes(x = ChestPainType, y = count, fill = as.factor(chol_level)), position = "fill") +
  labs(title = "Frequency of Chest Pain Type by Cholesterol Level",
       x = "Chest Pain Type",
       y = "Proportion",
       fill = "Cholesterol Level")

disease_grouped %>%
  mutate(HeartDisease, disease_cat=ifelse(HeartDisease==0, "Normal","Disease")) %>%
  ggplot()+
  geom_col(aes(x = ChestPainType, y = count, fill = as.factor(HeartDisease)), position = "fill")+
  labs(title = "Frequency of Chest Pain Type by Heart Disease",
       x = "Chest Pain Type",
       y = "Proportion")
```

# Statistical Tests
```{r tables}
sex_table <- heart_grouped %>%
  tabyl(Sex, ChestPainType)

exer_table <- heart_grouped %>%
  tabyl(ExerciseAngina, ChestPainType)

RBP_table <- heart_grouped %>%
  tabyl(press_level, ChestPainType)

chol_table <- heart_grouped_chol %>%
  tabyl(chol_level, ChestPainType)

disease_table <- heart_grouped %>%
  tabyl(HeartDisease, ChestPainType)
```

```{r chisq}
chisq.test(sex_table)
chisq.test(exer_table)
```

```{r chi-squared}
chisq.test(chol_table)
chisq.test(RBP_table)
chisq.test(disease_table)
```

```{r new-groups}
heart_grouped2 <- heart_grouped %>%
  filter(ChestPainType %in% c("ATA", "ASY")) 

heart_grouped3 <- heart_grouped %>%
  filter(ChestPainType %in% c("ASY", "NAP")) 

heart_grouped4 <- heart_grouped %>%
  filter(ChestPainType %in% c("TA", "ASY")) 

heart_grouped5 <- heart_grouped %>%
  filter(ChestPainType %in% c("ATA", "NAP")) 

heart_grouped6 <- heart_grouped %>%
  filter(ChestPainType %in% c("ATA", "TA")) 

heart_grouped7 <- heart_grouped %>%
  filter(ChestPainType %in% c("NAP", "TA")) 
```


```{r step-down-sex}

sex_step3 <- heart_grouped4 %>% #NOT SIGNIFICANT
  tabyl(Sex, ChestPainType)
fisher.test(sex_step3)

sex_step5 <- heart_grouped6 %>% #NOT SIGNIFICANT
  tabyl(Sex, ChestPainType)
fisher.test(sex_step5)

```

```{r step-down-exercise}

exer_step3 <- heart_grouped4 %>% 
  tabyl(ExerciseAngina, ChestPainType)
fisher.test(exer_step3)

exer_step5 <- heart_grouped6 %>% #NOT SIGNIFICANT
  tabyl(ExerciseAngina, ChestPainType)
fisher.test(exer_step5)

```

```{r step-down-RBP}

RBP_step3 <- heart_grouped4 %>% #NOT SIG
  tabyl(press_level, ChestPainType)
fisher.test(RBP_step3)

RBP_step5 <- heart_grouped6 %>% 
  tabyl(press_level, ChestPainType)
fisher.test(RBP_step5)

```
```{r disease-step-down}

disease_step3 <- heart_grouped4 %>%
  tabyl(HeartDisease, ChestPainType)
fisher.test(disease_step3)

disease_step5 <- heart_grouped6 %>%
  tabyl(HeartDisease, ChestPainType)
fisher.test(disease_step5)
```

# Results

```{r T1, out.width = "50%"}
knitr::include_graphics("Screen_Shot_T1.png")
```

```{r T2, out.width = "75%"}
knitr::include_graphics("Screen_Shot_T2.png")

```

```{r graphsTA-ATA, fig.show = "hold", out.width = "50%"}

ggplot(data = heart_grouped6)+
  geom_bar(mapping = aes(x = press_level, fill = ChestPainType), position = "fill")+
  labs(title = "Proportion of Chest Pain Type",
  subtitle = "By Blood Pressure Level", x= "Blood Pressure Level", y = "Proportion", fill = "Chest Pain Type" )

heart_grouped6 %>%
   mutate(HeartDisease, heart_factor=ifelse(HeartDisease=="1", "Heart Disease", "Normal")) %>%
ggplot()+
  geom_bar(mapping = aes(x = heart_factor, fill = ChestPainType), position = "fill")+
  labs(title = "Proportion of Chest Pain Type",
  subtitle = "By Whether the Patient Has Heart Disease", x = "Whether the Patient Has Heart Disease", y = "Proportion", fill = "Chest Pain Type")

heart_grouped4 %>%
  mutate(HeartDisease, heart_factor=ifelse(HeartDisease=="1", "Heart Disease", "Normal")) %>%
  ggplot()+
  geom_bar(mapping = aes(x = heart_factor, fill = ChestPainType), position = "fill")+
  labs(title = "Proportion of Chest Pain Type",
  subtitle = "By Whether the Patient Has Heart Disease", x = "Whether the Patient Has Heart Disease", y = "Proportion", fill = "Chest Pain Type")

ggplot(data = heart_grouped4)+
geom_bar(mapping = aes(x = as.factor(ExerciseAngina), fill = ChestPainType), position = "fill")+
  labs(title = "Proportion of Chest Pain Type",
  subtitle = "By Whether the Angina Was Exercise Induced", x = "Whether Angina was Exercise Induced", y = "Proportion", fill = "Chest Pain Type")

```

```{r log-reg1}

heart_grouped6.5 <- heart_grouped6 %>%
  mutate(ChestPainType, chest_factor=ifelse(ChestPainType=="TA", 0,1)) 

press_fit <- logistic_reg() %>%
   set_engine("glm") %>%
   fit(as.factor(chest_factor) ~ press_level + HeartDisease, data = heart_grouped6.5, family = "binomial")

tidy(press_fit, conf.int = TRUE, exponentiate = TRUE)

```
```{r log-reg2}

#TA = reference group

heart_grouped4.5 <- heart_grouped4 %>%
  mutate(ChestPainType, chest_factor=ifelse(ChestPainType=="TA", 0,1)) 

exer_fit <- logistic_reg() %>%
   set_engine("glm") %>%
   fit(as.factor(chest_factor) ~ ExerciseAngina + HeartDisease, data = heart_grouped4.5, family = "binomial")

tidy(exer_fit, conf.int = TRUE, exponentiate = TRUE)


```




```{r sex-stats}

heart_grouped4 %>%
 group_by(Sex) %>%
  summarize(count = n()) %>%
  print()

heart_grouped4 %>%
 group_by(Sex, ChestPainType) %>%
  summarize(count = n()) %>%
  print()

heart_grouped6 %>%
 group_by(Sex) %>%
  summarize(count = n()) %>%
  print()

heart_grouped6 %>%
 group_by(Sex, ChestPainType) %>%
  summarize(count = n()) %>%
  print()

```
```{r exer-stats, echo = FALSE}

heart_grouped4 %>%
 group_by(ExerciseAngina) %>%
  summarize(count = n()) %>%
  print()

heart_grouped4 %>%
 group_by(ExerciseAngina, ChestPainType) %>%
  summarize(count = n()) %>%
  print()

heart_grouped6 %>%
 group_by(ExerciseAngina) %>%
  summarize(count = n()) %>%
  print()

heart_grouped6 %>%
 group_by(ExerciseAngina, ChestPainType) %>%
  summarize(count = n()) %>%
  print()

```
```{r RBP-stats}
heart_grouped %>%
  group_by(press_level, ChestPainType) %>%
  summarize(count = n())%>%
  print()

heart_grouped4 %>%
  group_by(press_level, ChestPainType) %>%
  summarize(count = n())%>%
  print()

heart_grouped6 %>%
  group_by(press_level, ChestPainType) %>%
  summarize(count = n())%>%
  print()

```


# Discussion





